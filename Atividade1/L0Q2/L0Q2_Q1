#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#define SEPARATOR 32

typedef struct Node{
    int key;
    int tam;
    int num;
    struct Node * right;
    struct Node * left;
    struct Node * mother;
}Node;

typedef struct my_tree{
    Node * root;
}my_tree;

my_tree * Create_tree(my_tree * t){
    t = (my_tree *) malloc(sizeof(my_tree));
    t->root = NULL;
    return t;
}

void Search_all_tree(Node *);
my_tree * Insert_Tree(my_tree *, int);

int main(){

    FILE * file_in = fopen("L0Q1.in", "r");
    
    if(file_in == NULL) printf("Arquivo L0Q1.in não encontrado para abrir");
    else{
        FILE * file_out = fopen("L0Q1.out", "w");

        if(file_out == NULL) printf("Arquivo L0Q1.out não foi criado");
        else{

            char buffer[100];

            while(fgets(buffer, sizeof(buffer), file_in) != NULL){

                my_tree * Tree = Create_tree(Tree);
                char * copy = strdup(buffer);

                if(!copy){ 
                    printf("Alocação de memória falhou");
                    return;
                }

                char separator[2] = {SEPARATOR, '\0'};

                char * token = strtok(copy, separator);
                while(token != NULL){
                    Tree = Insert_Tree(Tree, atoi(token));
                    token = strtok(NULL, copy);
                }
                copy = strdup(buffer);

                if(!copy){ 
                    printf("Alocação de memória falhou");
                    return;
                }
                token = strtok(copy, separator);
                int tam;
                while(token != NULL){
                    tam = search_heights(Tree->root, atoi(token));
                    fprintf(file_out, "%d ", tam);
                    token = strtok(NULL, copy);
                }
                fprintf(file_out, "\n");
            }
            fclose(file_out);
        }
        fclose(file_in);
    }

}

my_tree * Insert_Tree(my_tree * t, int key){
    
    if(t == NULL)
       t = Create_tree(t);
    
    Node * new = (Node *) malloc(sizeof(Node));
    new->right = NULL;
    new->left = NULL;
    new->key = key;
    new->num = 0;
    
    Node * sacrifice = t->root;
    Node * mother = t->root;
    
    while(sacrifice != NULL){
        mother = sacrifice;
        
        if(key >= sacrifice->key) sacrifice = sacrifice->right;
        else sacrifice = sacrifice->left;
    }
    if(mother == NULL){
        new->mother = mother;
        new->tam = 0;
        t->root = new;
        return t;
    }
    
    if(key >= mother->key) mother->right = new;
    else mother->left = new;
    
    new->mother = mother;
    new->tam = mother->tam + 1;
    return t;
}
int search_heights(Node * root, int key){

    while(key != root->key || root->num == 1){

        if(key < root->key) root = root->left;
        else root = root->right;
    }
    root->num = 1;
    return root->tam;
}
void Search_all_tree(Node * root){
    if(root != NULL){
        Search_all_tree(root->left);
        printf("%d\n", root->key);
        Search_all_tree(root->right);
    }
}